<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Unit tests for tinymce.dom.Serializer</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-git.css" type="text/css" />
<script src="http://code.jquery.com/qunit/qunit-git.js"></script>
<script src="qunit/connector.js"></script>
<script type="text/javascript" src="qunit/runner.js"></script>
<script type="text/javascript" src="js/tiny_mce_loader.js"></script>
</head>
<body>
<script type="text/javascript">
var DOM = tinymce.DOM;

module("tinymce.dom.Serializer", {
});

test('Schema rules', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(8);

	ser.setRules('@[id|title|class|style],div,img[src|alt|-style|border],span,hr');
	DOM.setHTML('test', '<img title="test" src="file.gif" data-mce-src="file.gif" alt="test" border="0" style="border: 1px solid red" class="test" /><span id="test2">test</span><hr />');
	equals(ser.serialize(DOM.get('test')), '<div id="test"><img title="test" class="test" src="file.gif" alt="test" border="0" /><span id="test2">test</span><hr /></div>', 'Global rule');

	ser.setRules('*a[*],em/i[*],strong/b[*i*]');
	DOM.setHTML('test', '<a href="test" data-mce-href="test">test</a><strong title="test" class="test">test2</strong><em title="test">test3</em>');
	equals(ser.serialize(DOM.get('test')), '<a href="test">test</a><strong title="test">test2</strong><em title="test">test3</em>', 'Wildcard rules');

	ser.setRules('br,hr,input[type|name|value],div[id],span[id],strong/b,a,em/i,a[!href|!name],img[src|border=0|title={$uid}]');
	DOM.setHTML('test', '<br /><hr /><input type="text" name="test" value="val" class="no" /><span id="test2" class="no"><b class="no">abc</b><em class="no">123</em></span>123<a href="file.html"  data-mce-href="file.html">link</a><a name="anchor"></a><a>no</a><img src="file.gif" data-mce-src="file.gif" />');
	equals(ser.serialize(DOM.get('test')), '<div id="test"><br /><hr /><input type="text" name="test" value="val" /><span id="test2"><strong>abc</strong><em>123</em></span>123<a href="file.html">link</a><a name="anchor"></a>no<img src="file.gif" border="0" title="mce_0" /></div>', 'Output name and attribute rules');

	ser.setRules('a[href|target<_blank?_top|title:forced value]');
	DOM.setHTML('test', '<a href="file.htm" data-mce-href="file.htm" target="_blank" title="title">link</a><a href="#" data-mce-href="#" target="test">test2</a>');
	equals(ser.serialize(DOM.get('test')), '<a href="file.htm" target="_blank" title="forced value">link</a><a href="#" title="forced value">test2</a>');

	ser.setRules('img[src|border=0|alt=]');
	DOM.setHTML('test', '<img src="file.gif" data-mce-src="file.gif" border="0" alt="" />');
	equals(ser.serialize(DOM.get('test')), '<img src="file.gif" border="0" alt="" />', 'Default attribute with empty value');

	ser.setRules('img[src|border=0|alt=],*[*]');
	DOM.setHTML('test', '<img src="file.gif" data-mce-src="file.gif" /><hr />');
	equals(ser.serialize(DOM.get('test')), '<div id="test"><img src="file.gif" border="0" alt="" /><hr /></div>');

	ser = new tinymce.dom.Serializer({valid_elements : 'img[src|border=0|alt=]', extended_valid_elements : 'div[id],img[src|alt=]'});
	DOM.setHTML('test', '<img src="file.gif" data-mce-src="file.gif" alt="" />');
	equals(ser.serialize(DOM.get('test')), '<div id="test"><img src="file.gif" alt="" /></div>');

	ser = new tinymce.dom.Serializer({invalid_elements : 'hr,br'});
	DOM.setHTML('test', '<img src="file.gif" data-mce-src="file.gif" /><hr /><br />');
	equals(ser.serialize(DOM.get('test')), '<div id="test"><img src="file.gif" alt="" /></div>');
});

test('Entity encoding', function() {
	var ser;

	expect(4);

	ser = new tinymce.dom.Serializer({entity_encoding : 'numeric'});
	DOM.setHTML('test', '&lt;&gt;&amp;&quot;&nbsp;&aring;&auml;&ouml;');
	equals(ser.serialize(DOM.get('test')), '<div id="test">&lt;&gt;&amp;"&#160;&#229;&#228;&#246;</div>');

	ser = new tinymce.dom.Serializer({entity_encoding : 'named'});
	DOM.setHTML('test', '&lt;&gt;&amp;&quot;&nbsp;&aring;&auml;&ouml;');
	equals(ser.serialize(DOM.get('test')), '<div id="test">&lt;&gt;&amp;"&nbsp;&aring;&auml;&ouml;</div>');

	ser = new tinymce.dom.Serializer({entity_encoding : 'named+numeric', entities : '160,nbsp,34,quot,38,amp,60,lt,62,gt'});
	DOM.setHTML('test', '&lt;&gt;&amp;&quot;&nbsp;&aring;&auml;&ouml;');
	equals(ser.serialize(DOM.get('test')), '<div id="test">&lt;&gt;&amp;"&nbsp;&#229;&#228;&#246;</div>');

	ser = new tinymce.dom.Serializer({entity_encoding : 'raw'});
	DOM.setHTML('test', '&lt;&gt;&amp;&quot;&nbsp;&aring;&auml;&ouml;');
	equals(ser.serialize(DOM.get('test')), '<div id="test">&lt;&gt;&amp;"\u00a0\u00e5\u00e4\u00f6</div>');
});

test('Form elements (general)', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(5);

	ser.setRules('form[method],label[for],input[type|name|value|checked|disabled|readonly|length|maxlength],select[multiple],option[value|selected],textarea[name|disabled|readonly]');

	DOM.setHTML('test', '<input type="text" />');
	equals(ser.serialize(DOM.get('test')), '<input type="text" />');

	DOM.setHTML('test', '<input type="text" value="text" length="128" maxlength="129" />');
	equals(ser.serialize(DOM.get('test')), '<input type="text" value="text" length="128" maxlength="129" />');

	DOM.setHTML('test', '<form method="post"><input type="hidden" name="method" value="get" /></form>');
	equals(ser.serialize(DOM.get('test')), '<form method="post"><input type="hidden" name="method" value="get" /></form>');

	DOM.setHTML('test', '<label for="test">label</label>');
	equals(ser.serialize(DOM.get('test')), '<label for="test">label</label>');

	DOM.setHTML('test', '<input type="checkbox" value="test" /><input type="button" /><textarea></textarea>');
	equals(ser.serialize(DOM.get('test')), '<input type="checkbox" value="test" /><input type="button" /><textarea></textarea>');
});

test('Form elements (checkbox)', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(4);

	ser.setRules('form[method],label[for],input[type|name|value|checked|disabled|readonly|length|maxlength],select[multiple],option[value|selected]');

	DOM.setHTML('test', '<input type="checkbox" value="1">');
	equals(ser.serialize(DOM.get('test')), '<input type="checkbox" value="1" />');

	DOM.setHTML('test', '<input type="checkbox" value="1" checked disabled readonly>');
	equals(ser.serialize(DOM.get('test')), '<input type="checkbox" value="1" checked="checked" disabled="disabled" readonly="readonly" />');

	DOM.setHTML('test', '<input type="checkbox" value="1" checked="1" disabled="1" readonly="1">');
	equals(ser.serialize(DOM.get('test')), '<input type="checkbox" value="1" checked="checked" disabled="disabled" readonly="readonly" />');

	DOM.setHTML('test', '<input type="checkbox" value="1" checked="true" disabled="true" readonly="true">');
	equals(ser.serialize(DOM.get('test')), '<input type="checkbox" value="1" checked="checked" disabled="disabled" readonly="readonly" />');
});

test('Form elements (select)', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(7);

	ser.setRules('form[method],label[for],input[type|name|value|checked|disabled|readonly|length|maxlength],select[multiple],option[value|selected]');

	DOM.setHTML('test', '<select><option value="1">test1</option><option value="2" selected>test2</option></select>');
	equals(ser.serialize(DOM.get('test')), '<select><option value="1">test1</option><option value="2" selected="selected">test2</option></select>');

	DOM.setHTML('test', '<select><option value="1">test1</option><option selected="1" value="2">test2</option></select>');
	equals(ser.serialize(DOM.get('test')), '<select><option value="1">test1</option><option value="2" selected="selected">test2</option></select>');

	DOM.setHTML('test', '<select><option value="1">test1</option><option value="2" selected="true">test2</option></select>');
	equals(ser.serialize(DOM.get('test')), '<select><option value="1">test1</option><option value="2" selected="selected">test2</option></select>');

	DOM.setHTML('test', '<select multiple></select>');
	equals(ser.serialize(DOM.get('test')), '<select multiple="multiple"></select>');

	DOM.setHTML('test', '<select multiple="multiple"></select>');
	equals(ser.serialize(DOM.get('test')), '<select multiple="multiple"></select>');

	DOM.setHTML('test', '<select multiple="1"></select>');
	equals(ser.serialize(DOM.get('test')), '<select multiple="multiple"></select>');

	DOM.setHTML('test', '<select></select>');
	equals(ser.serialize(DOM.get('test')), '<select></select>');
});

test('List elements', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(5);

	ser.setRules('ul[compact],ol,li');

	DOM.setHTML('test', '<ul compact></ul>');
	equals(ser.serialize(DOM.get('test')), '<ul compact="compact"></ul>');

	DOM.setHTML('test', '<ul compact="compact"></ul>');
	equals(ser.serialize(DOM.get('test')), '<ul compact="compact"></ul>');

	DOM.setHTML('test', '<ul compact="1"></ul>');
	equals(ser.serialize(DOM.get('test')), '<ul compact="compact"></ul>');

	DOM.setHTML('test', '<ul></ul>');
	equals(ser.serialize(DOM.get('test')), '<ul></ul>');

	DOM.setHTML('test', '<ol><li>a</li><ol><li>b</li><li>c</li></ol><li>e</li></ol>');
	equals(ser.serialize(DOM.get('test')), '<ol><li>a<ol><li>b</li><li>c</li></ol></li><li>e</li></ol>');
});

test('Tables', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(4);

	ser.setRules('table,tr,td[nowrap]');

	DOM.setHTML('test', '<table><tr><td></td></tr></table>');
	equals(ser.serialize(DOM.get('test')), '<table><tr><td></td></tr></table>');

	DOM.setHTML('test', '<table><tr><td nowrap></td></tr></table>');
	equals(ser.serialize(DOM.get('test')), '<table><tr><td nowrap="nowrap"></td></tr></table>');

	DOM.setHTML('test', '<table><tr><td nowrap="nowrap"></td></tr></table>');
	equals(ser.serialize(DOM.get('test')), '<table><tr><td nowrap="nowrap"></td></tr></table>');

	DOM.setHTML('test', '<table><tr><td nowrap="1"></td></tr></table>');
	equals(ser.serialize(DOM.get('test')), '<table><tr><td nowrap="nowrap"></td></tr></table>');
});

test('Styles', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(1);

	ser.setRules('*[*]');

	DOM.setHTML('test', '<span style="border: 1px solid red" data-mce-style="border: 1px solid red;">test</span>');
	equals(ser.serialize(DOM.get('test')), '<div id="test"><span style="border: 1px solid red;">test</span></div>');
});

test('Comments', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(1);

	ser.setRules('*[*]');

	DOM.setHTML('test', '<!-- abc -->');
	equals(ser.serialize(DOM.get('test')), '<div id="test"><!-- abc --></div>');
});

test('Non HTML elements and attributes', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(2);

	ser.setRules('*[*]');
	ser.schema.addValidChildren('+div[prefix:test]');

	DOM.setHTML('test', '<div test:attr="test">test</div>');
	equals(ser.serialize(DOM.get('test'), {getInner : 1}), '<div test:attr="test">test</div>');

	DOM.setHTML('test', 'test1<prefix:test>Test</prefix:test>test2');
	equals(ser.serialize(DOM.get('test')), '<div id="test">test1<prefix:test>Test</prefix:test>test2</div>');
});

test('Padd empty elements', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(1);

	ser.setRules('#p');

	DOM.setHTML('test', '<p>test</p><p></p>');
	equals(ser.serialize(DOM.get('test')), '<p>test</p><p>&nbsp;</p>');
});

test('Remove empty elements', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(1);

	ser.setRules('-p');

	DOM.setHTML('test', '<p>test</p><p></p>');
	equals(ser.serialize(DOM.get('test')), '<p>test</p>');
});

test('Pre/post process events', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(3);

	ser.setRules('div[id],span[id|class],a[href],b[class]');

	ser.onPreProcess.add(function(se, o) {
		equals(o.test, 'abc');
		DOM.setAttrib(o.node.getElementsByTagName('span')[0], 'class', 'abc');
	});

	ser.onPostProcess.add(function(se, o) {
		equals(o.test, 'abc');
		o.content = o.content.replace(/<b>/g, '<b class="123">');
	});

	DOM.setHTML('test', '<span id="test2"><b>abc</b></span>123<a href="file.html" data-mce-href="file.html">link</a>');
	equals(ser.serialize(DOM.get('test'), {test : 'abc'}), '<div id="test"><span id="test2" class="abc"><b class="123">abc</b></span>123<a href="file.html">link</a></div>');
});

test('Scripts', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(10);

	ser.setRules('script[type|language|src]');

	DOM.setHTML('test', '<s'+'cript>// <img src="test"><a href="#"></a></s'+'cript>');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '<s'+'cript type="text/javascript">// <![CDATA[\n// <img src="test"><a href="#"></a>\n// ]]></s'+'cript>');

	DOM.setHTML('test', '<s'+'cript>1 < 2;</s'+'cript>');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '<s'+'cript type="text/javascript">// <![CDATA[\n1 < 2;\n// ]]></s'+'cript>');

	DOM.setHTML('test', '<s'+'cript type="text/javascript">1 < 2;</s'+'cript>');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '<script type="text/javascript">// <![CDATA[\n1 < 2;\n// ]]></s'+'cript>');

	DOM.setHTML('test', '<script type="text/javascript">\n\t1 < 2;\n\t if (2 < 1)\n\t\talert(1);\n</s'+'cript>');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '<s'+'cript type="text/javascript">// <![CDATA[\n\t1 < 2;\n\t if (2 < 1)\n\t\talert(1);\n// ]]></s'+'cript>');

	DOM.setHTML('test', '<script type="text/javascript"><!-- 1 < 2; // --></s'+'cript>');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '<s'+'cript type="text/javascript">// <![CDATA[\n 1 < 2;\n// ]]></s'+'cript>');

	DOM.setHTML('test', '<script type="text/javascript">\n\n<!-- 1 < 2;\n\n--></s'+'cript>');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '<s'+'cript type="text/javascript">// <![CDATA[\n 1 < 2;\n// ]]></s'+'cript>');

	DOM.setHTML('test', '<script type="text/javascript">// <![CDATA[1 < 2; // ]]></s'+'cript>');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '<s'+'cript type="text/javascript">// <![CDATA[\n1 < 2;\n// ]]></s'+'cript>');

	DOM.setHTML('test', '<script type="text/javascript"><![CDATA[1 < 2; ]]></s'+'cript>');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '<s'+'cript type="text/javascript">// <![CDATA[\n1 < 2;\n// ]]></s'+'cript>');

	DOM.setHTML('test', '<script type="text/javascript">\n\n<![CDATA[\n\n1 < 2;\n\n]]>\n\n</s'+'cript>');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '<s'+'cript type="text/javascript">// <![CDATA[\n1 < 2;\n// ]]></s'+'cript>');

	DOM.setHTML('test', '<script type="text/javascript" src="test.js" data-mce-src="test.js"></s'+'cript>');
	equals(ser.serialize(DOM.get('test')), '<s'+'cript type="text/javascript" src="test.js"></s'+'cript>');
});

test('Protected blocks', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(3);

	ser.setRules('noscript[test]');

	DOM.setHTML('test', '<!--mce:protected ' + escape('<noscript test="test"><br></noscript>') + '-->');
	equals(ser.serialize(DOM.get('test')), '<noscript test="test"><br></noscript>');

	DOM.setHTML('test', '<!--mce:protected ' + escape('<noscript><br></noscript>') + '-->');
	equals(ser.serialize(DOM.get('test')), '<noscript><br></noscript>');

	DOM.setHTML('test', '<!--mce:protected ' + escape('<noscript><!-- text --><br></noscript>') + '-->');
	equals(ser.serialize(DOM.get('test')), '<noscript><!-- text --><br></noscript>');
});

test('Style', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, valid_children: '+body[style]', dom : DOM});

	expect(2);

	ser.setRules('style');

	ser.setRules('style');
	DOM.setHTML('test', '<style> body { background:#fff }</style>');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '<style><!--\n body { background:#fff }\n--></style>');

	ser.setRules('style');
	DOM.setHTML('test', '<style>\r\n<![CDATA[\r\n   body { background:#fff }]]></style>');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '<style><!--\n   body { background:#fff }\n--></style>');
});

test('CDATA', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(2);

	ser.setRules('span');

	DOM.setHTML('test', '123<!--[CDATA[<test>]]-->abc');
	equals(ser.serialize(DOM.get('test')), '123<![CDATA[<test>]]>abc');

	DOM.setHTML('test', '123<!--[CDATA[<te\n\nst>]]-->abc');
	equals(ser.serialize(DOM.get('test')).replace(/\r/g, ''), '123<![CDATA[<te\n\nst>]]>abc');
});

test('BR at end of blocks', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(1);

	ser.setRules('ul,li,br');

	DOM.setHTML('test', '<ul><li>test<br /></li><li>test<br /></li><li>test<br /></li></ul>');
	equals(ser.serialize(DOM.get('test')), '<ul><li>test</li><li>test</li><li>test</li></ul>');
});

test('Map elements', function() {
	var ser = new tinymce.dom.Serializer({fix_list_elements : true, dom : DOM});

	expect(1);

	ser.setRules('map[id|name],area[shape|coords|href|target|alt]');

	DOM.setHTML('test', '<map id="planetmap" name="planetmap"><area shape="rect" coords="0,0,82,126" href="sun.htm" data-mce-href="sun.htm" target="_blank" alt="sun" /></map>');
	equals(ser.serialize(DOM.get('test')).toLowerCase(), '<map id="planetmap" name="planetmap"><area shape="rect" coords="0,0,82,126" href="sun.htm" target="_blank" alt="sun" /></map>');
});

test('Custom elements', function() {
	var ser = new tinymce.dom.Serializer({}, DOM, new tinymce.html.Schema({custom_elements: 'custom1,~custom2', valid_elements: 'custom1,custom2'}));

	document.createElement('custom1');
	document.createElement('custom2');

	DOM.setHTML('test', '<p><custom1>c1</custom1><custom2>c2</custom2></p>');
	equals(ser.serialize(DOM.get('test')), '<custom1>c1</custom1><custom2>c2</custom2>');
});
</script>

	<h1 id="qunit-header">Unit tests for tinymce.dom.Serializer</h1>
	<h2 id="qunit-banner"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="content">
		<div id="test"></div>
	</div>
</body>
</html>
